#!/bin/bash

# –û—Å—Ç–∞–Ω–æ–≤–∏–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –∫–∞–∫–∞—è-—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤–µ—Ä–Ω—ë—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π
set -e

echo "‚öôÔ∏è  –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ python3..."
if ! command -v python3 &> /dev/null; then
    echo "‚ùå python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
    exit 1
fi

echo "‚öôÔ∏è  –ü—Ä–æ–≤–µ—Ä—è—é –Ω–∞–ª–∏—á–∏–µ docker-compose..."
if ! command -v docker-compose &> /dev/null; then
    echo "‚ùå docker-compose –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ docker-compose, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞."
    exit 1
fi

echo "üêç –°–æ–∑–¥–∞—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv..."
python3 -m venv .venv

echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ .venv —Å–æ–∑–¥–∞–Ω–æ."

echo "üîÑ –ê–∫—Ç–∏–≤–∏—Ä—É—é .venv..."
source .venv/bin/activate

echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install --upgrade pip
pip install -r requirements.txt

echo "üîë –ó–∞–≥—Ä—É–∂–∞—é –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å .env)..."
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
    echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã."
else
    echo "‚ö†Ô∏è –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞—é –∑–∞–≥—Ä—É–∑–∫—É –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö."
fi

echo "üê≥ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ Docker Compose..."
docker-compose up -d

echo "‚è≥ –î–µ–ª–∞—é –Ω–µ–±–æ–ª—å—à—É—é –ø–∞—É–∑—É (5 —Å–µ–∫—É–Ω–¥), —á—Ç–æ–±—ã PostgreSQL —É—Å–ø–µ–ª –ø–æ–¥–Ω—è—Ç—å—Å—è..."
sleep 5

echo "üîÑ –ü—Ä–∏–º–µ–Ω—è—é –º–∏–≥—Ä–∞—Ü–∏–∏ Django..."
python manage.py migrate

echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Django..."
python manage.py runserver

echo "‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ! –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É http://127.0.0.1:8000"
